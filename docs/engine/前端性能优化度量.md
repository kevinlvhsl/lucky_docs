æˆ‘ä»¬ç»å¸¸èƒ½çœ‹åˆ°å¤§é‡ä»‹ç»å‰ç«¯å¦‚ä½•è¿›è¡Œæ€§èƒ½ä¼˜åŒ–çš„æ–‡ç« ã€‚ç„¶è€Œå¾ˆå¤šæ–‡ç« åªä»‹ç»äº†å¦‚ä½•ä¼˜åŒ–æ€§èƒ½ï¼Œå´æœªèƒ½ç»™å‡ºä¸€ä¸ªå¯è®¡ç®—ï¼Œå¯é‡‡é›†çš„æ€§èƒ½é‡åŒ–æ ‡å‡†ã€‚æ­¤æ–‡å°±ç®€å•ä»‹ç»ä¸€ä¸‹å‰ç«¯æ€§èƒ½ä¼˜åŒ–çš„åº¦é‡æ–¹æ¡ˆã€‚

é¦–å…ˆæ¥ä¸€å¼ æ•´ä¸ª web è¯·æ±‚åŠ è½½çš„æµç¨‹å›¾ï¼Œè¿™äº› api éƒ½å¯ä»¥åœ¨`performance.timingä¸­è·å–`

![](/images/gmtc/performance/web.png)

![](/images/gmtc/performance/timing.png)

## ä¸€ã€æ€§èƒ½ä¼˜åŒ–å¸¸ç”¨åº¦é‡æ–¹æ³•

![](/images/gmtc/performance/method.png)

**è¯´æ˜**
å…¶ä¸­ `lcp`å’Œ`tbt`å’Œ`CLS`å°†ä¼šåœ¨ 2020 å¹´å‘å¸ƒ API.

### FP å’Œ FCP åº¦é‡æ–¹æ³•

`FP` å’Œ `FCP` åˆ†åˆ«æ˜¯é¡µé¢é¦–æ¬¡ç»˜åˆ¶å’Œé¦–æ¬¡å†…å®¹ç»˜åˆ¶ã€‚

[å‚è€ƒèµ„æ–™: w3c paint](https://w3c.github.io/paint-timing/?spm=a2c4e.10696291.0.0.174719a4TO3RdZ#first-paint)

- é¦–æ¬¡ç»˜åˆ¶åŒ…æ‹¬äº†ä»»ä½•ç”¨æˆ·è‡ªå®šä¹‰çš„èƒŒæ™¯ç»˜åˆ¶ï¼Œå®ƒæ˜¯é¦–å…ˆå°†åƒç´ ç»˜åˆ¶åˆ°å±å¹•çš„æ—¶åˆ»ã€‚
- é¦–æ¬¡å†…å®¹ç»˜åˆ¶æ˜¯æµè§ˆå™¨å°†ç¬¬ä¸€ä¸ª DOM æ¸²æŸ“åˆ°å±å¹•çš„æ—¶é—´ã€‚è¯¥æŒ‡æ ‡æŠ¥å‘Šäº†æµè§ˆå™¨é¦–æ¬¡å‘ˆç°ä»»ä½•æ–‡æœ¬ã€å›¾åƒã€ç”»å¸ƒæˆ–è€… SVG çš„æ—¶é—´ã€‚
- è¿™ä¸¤ä¸ªæŒ‡æ ‡å…¶å®æŒ‡ç¤ºäº†æˆ‘ä»¬é€šå¸¸æ‰€è¯´çš„**ç™½å±æ—¶é—´**ã€‚

```js
let perfomanceMetrics = {};
const observer = new PerformanceObserver(list => {
  for (const entry of list.getEntries()) {
    // `entry` is a PerformanceEntry instance.
    // `name` will be either 'first-paint' or 'first-contentful-paint'.
    const metricName = entry.name;
    const time = Math.round(entry.startTime + entry.duration);
    if (metricName === "first-paint") {
      perfomanceMetrics.fp = time;
    }
    if (metricName === "first-contentful-paint") {
      perfomanceMetrics.fcp = time;
    }
  }
});

// Start observing the entry types you care about.
observer.observe({ entryTypes: ["paint"] });
```

![](/images/gmtc/performance/fp-fcp.png)

### FMP(é¦–æ¬¡æœ‰æ„ä¹‰ç»˜åˆ¶) åº¦é‡æ–¹æ³•ã€é‡ç‚¹ã€‘

ç›®å‰ï¼Œå¤§å¤šæ•°å…¬å¸éƒ½ä½¿ç”¨ `FMP`ä½œä¸ºæŒ‡æ ‡æ¥è¡¡é‡**é¦–å±æ€§èƒ½**ã€‚ä½†æ˜¯åœ¨æœªæ¥/2020 å¹´ è°·æ­Œå°†ä¼šå‘å¸ƒä¸€ä¸ªæ–°çš„è¡¡é‡æ–¹å¼`LCP`,ä¹Ÿå°±æ˜¯é¦–å±é¡µé¢æœ€é•¿åŠ è½½æ—¶é—´ä½œä¸ºé¦–å±çš„åº¦é‡ã€‚**FMP çš„æ—¶æœºå…¶å®æ˜¯åœ¨æ•´ä¸ªé¡µé¢ç»˜åˆ¶å®Œæˆï¼Œä½†ä¸ä¸€å®šèƒ½è¿›è¡Œå‰ç«¯äº¤äº’ã€‚**

`FMP(First meaningful paint and hero element timing)`ã€‚å› ä¸ºå¾ˆéš¾æœ‰ä¸€ä¸ªé€šç”¨æ ‡å‡†æ¥æŒ‡ç¤ºæ‰€æœ‰çš„é¡µé¢å½“å‰æ—¶åˆ»çš„æ¸²æŸ“è¾¾æ˜¯å¦åˆ°äº†æœ‰ç”¨çš„ç¨‹åº¦ï¼Œæ‰€ä»¥å½“å‰å¹¶æ²¡æœ‰åˆ¶å®šæ ‡å‡†ã€‚å¯¹äºå¼€å‘è€…ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„é¡µé¢æ¥ç¡®å®šé‚£ä¸€éƒ¨åˆ†æ˜¯æœ€é‡è¦çš„ï¼Œç„¶ååº¦é‡è¿™éƒ¨åˆ†æ¸²æŸ“å‡ºçš„æ—¶é—´ä½œä¸º FMPã€‚

[Google Time to First Meaningful Paint: a layout-based approach](https://docs.google.com/document/d/1BR94tJdZLsin5poeet0XoTW60M0SjvOJQttKT-JK8HI/edit?spm=a2c4e.10696291.0.0.3d6119a44lTmFj)

chrome æä¾›çš„æ€§èƒ½åˆ†æå·¥å…· `Lighthouse` å¯ä»¥æµ‹é‡å‡ºé¡µé¢çš„ FMPï¼Œåœ¨æŸ¥é˜…äº†ä¸€äº›èµ„æ–™åï¼Œå‘ç° Lighthouse ä½¿ç”¨çš„ç®—æ³•æ˜¯ï¼š**é¡µé¢ç»˜åˆ¶å¸ƒå±€å˜åŒ–æœ€å¤§çš„é‚£æ¬¡ç»˜åˆ¶ï¼ˆæ ¹æ® é¡µé¢é«˜åº¦/å±å¹•é«˜åº¦ è°ƒèŠ‚æƒé‡ï¼‰**ã€‚

![](/images/gmtc/performance/lighthouse-fmp.png)

### TTI(å¯äº¤äº’æ—¶é—´) åº¦é‡æ–¹å¼

[TTI æ ‡å‡†å®šä¹‰æ–‡æ¡£](https://docs.google.com/document/d/1GGiI9-7KeY3TPqS3YT271upUVimo-XiL5mwWorDUD4c/preview?spm=a2c4e.10696291.0.0.335019a4l7uGuD)

> TTI ä¸»è¦æ˜¯é€šè¿‡è·Ÿè¸ªè€—æ—¶è¾ƒé•¿çš„ä»»åŠ¡æ¥ç¡®å®šï¼Œè®¾ç½®`PerformanceObserver`è§‚å¯Ÿç±»å‹ä¸º `longtask` çš„æ¡ç›®ï¼Œ
> ç„¶åå¯ä»¥æ ¹æ®è€—æ—¶è¾ƒé•¿çš„æ¡ç›®çš„ startTime å’Œ durationï¼Œæ¥å¤§è‡´ç¡®è®¤é¡µé¢å¤„äº idle çš„æ—¶é—´ï¼Œä»è€Œç¡®å®š `TTI` æŒ‡æ ‡ã€‚
> Google å¸Œæœ›å°† TTI æŒ‡æ ‡æ ‡å‡†åŒ–ï¼Œå¹¶é€šè¿‡ `PerformanceObserver` åœ¨æµè§ˆå™¨ä¸­å…¬å¼€ï¼Œä½†ç›®å‰å¹¶ä¸æ”¯æŒã€‚
> ç›®å‰åªèƒ½é€šè¿‡ä¸€ä¸ª `polyfill`ï¼Œæ£€æµ‹ç›®å‰çš„ `TTI`ï¼Œé€‚ç”¨äºæ‰€æœ‰æ”¯æŒ `Long Tasks API` çš„æµè§ˆå™¨ã€‚
> è¯¥ `polyfill` å…¬å¼€ `getFirstConsistentlyInteractive()` æ–¹æ³•ï¼Œåè€…è¿”å›ä½¿ç”¨ TTI å€¼è¿›è¡Œè§£æçš„ promiseã€‚

åº¦é‡ TTI ä¸»è¦ä½¿ç”¨è°·æ­Œçš„[tti-polyfill](https://github.com/GoogleChromeLabs/tti-polyfill?spm=a2c4e.10696291.0.0.387e19a4Qoczy7)

ç¬¬ä¸€æ­¥ï¼šè®¾ç½® PerformanceObserverï¼Œå¹¶æŒ‡å®šç›‘æ§ç±»å‹ä¸º longtaskã€‚

```html
<script>
  !(function() {
    if ("PerformanceLongTaskTiming" in window) {
      var g = (window.__tti = { e: [] });
      g.o = new PerformanceObserver(function(l) {
        g.e = g.e.concat(l.getEntries());
      });
      g.o.observe({ entryTypes: ["longtask"] });
    }
  })();
</script>
```

ç¬¬äºŒæ­¥ï¼šå¼•å…¥ tti-polyfill.js(å¯é€šè¿‡ npm åŒ…è·å–)ï¼Œè·å–åˆ° tti çš„å€¼

```js
import ttiPolyfill from "/images/gmtc/performance/path/to/tti-polyfill.js";

ttiPolyfill.getFirstConsistentlyInteractive(opts).then(tti => {
  // Use `tti` value in some way.
});
```

### Long Tasks åº¦é‡æ–¹å¼

> å¦‚æœæœ‰ä¸€ä¸ªä»»åŠ¡éœ€è¦æ¶ˆè€—ç‰¹åˆ«é•¿çš„æ—¶é—´ï¼Œé‚£ä¹ˆé˜Ÿåˆ—ä¸­çš„å…¶ä»–ä»»åŠ¡å°†è¢«é˜»å¡ã€‚åŒæ—¶ï¼Œjs çº¿ç¨‹å’Œ ui æ¸²æŸ“çº¿ç¨‹æ˜¯äº’æ–¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœ js åœ¨æ‰§è¡Œï¼Œé‚£ä¹ˆ ui æ¸²æŸ“å°±è¢«é˜»å¡äº†ã€‚æ­¤æ—¶ï¼Œç”¨æˆ·åœ¨ä½¿ç”¨æ—¶å°†ä¼šæ„Ÿå—åˆ°å¡é¡¿å’Œé—ªçƒï¼Œè¿™æ˜¯å½“å‰ web é¡µé¢ä¸å¥½çš„ç”¨æˆ·ä½“éªŒçš„ä¸»è¦æ¥æºã€‚

[Lonag tasks API](https://w3c.github.io/longtasks/?spm=a2c4e.10696291.0.0.1e5e19a4ySu5K6) è®¤ä¸ºä¸€ä¸ªä»»åŠ¡å¦‚æœè¶…è¿‡äº† 50ms é‚£ä¹ˆå¯èƒ½æ˜¯æœ‰é—®é¢˜çš„ï¼Œå®ƒä¼šå°†è¿™äº›ä»»åŠ¡å±•ç¤ºç»™åº”ç”¨å¼€å‘è€…ã€‚é€‰æ‹© 50ms æ˜¯å› ä¸ºè¿™æ ·æ‰èƒ½æ»¡è¶³ RAIL æ¨¡å‹ ä¸­ç”¨æˆ·å“åº”è¦åœ¨ 100ms å†…çš„è¦æ±‚ã€‚

**åº¦é‡æ–¹å¼**
`Long Task`çš„åº¦é‡ä¹Ÿæ˜¯é‡‡ç”¨äº†[tti-polyfill](https://w3c.github.io/longtasks/?spm=a2c4e.10696291.0.0.1e5e19a4ySu5K)

```js
const observer = new PerformanceObserver(list => {
  for (const entry of list.getEntries()) {
    // `entry` is a PerformanceEntry instance.
    console.log(entry.entryType);
    console.log(entry.startTime); // DOMHighResTimeStamp
    console.log(entry.duration); // DOMHighResTimeStamp
  }
});

// register observer for long task notifications
observer.observe({ entryTypes: ["longtask"] });
```

## äºŒã€å¦‚ä½•è¡¡é‡æ€»ä½“æ€§èƒ½ï¼Ÿ

- ç»å¯¹å¹³å‡æ³•
- åŠ æƒå¹³å‡ æ³•
- ç§’å¼€ç‡ï¼Œåˆ†ä½æ³•
- å»å€¼å¹³å‡æ³•ï¼Œåˆ†ä½å¹³å‡å€¼
- æ•£ç‚¹å›¾ã€æ•°æ®åˆ†å±‚

## ä¸‰ã€é˜¿é‡Œå‰ç«¯æ€§èƒ½ä¼˜åŒ–ç‰¹è‰²æ–¹æ¡ˆ

### 1ã€æŒ‡å¯¼æ€æƒ³

![](/images/gmtc/performance/main-me.png)

- **å‡å°‘èµ„æº**

  - **è®©èµ„æºå˜å°**

    - å„ç§å‹ç¼©ç®—æ³•
    - API ä¼˜åŒ–

  - **ä¸‹è½½æ—¶é—´å˜å¿«**

    - åˆ©ç”¨ CDN å°±è¿‘è¯·æ±‚èµ„æº
    - ä¼˜åŒ– TTFB
    - åŠ¨æ€åŠ é€Ÿ

  - **æ‰“ç ´æ—¶é—´çª—å£**

    - é¢„åŠ è½½ä¸‹ä¸€é¡µèµ„æº
    - å„ç§ç¼“å­˜æ–¹æ¡ˆ
    - é¦–å±ä¼˜åŒ–

- **å‡å°‘æ‰§è¡Œ**

  - **å‡å°‘è®¡ç®—é‡**

    - ä»£ç è´¨é‡æå‡
    - ç”¨ SSR ä»£æ›¿ CSR

  - **è°ƒæ•´æ—¶åº**

    - api å¹¶è¡ŒåŠ è½½
    - å„ç§é¿å…å­—çœ¼é˜»å¡æ¸²æŸ“
    - è¾¹ç¼˜æµå¼è®¡ç®—æ–¹æ¡ˆ

### 2ã€ è¾¹ç¼˜æµå¼è®¡ç®—æ–¹æ¡ˆ

#### è¾¹ç¼˜æµå¼è®¡ç®—ä¼˜åŒ–é¦–è·³æ€§èƒ½

**å°†é¡µé¢åŠ¨é™åˆ†ç¦»ï¼Œé™æ€ç»“æ„ç¼“å­˜åœ¨ CDN,åŠ¨æ€å†…å®¹ç”± CDN å‘æœåŠ¡å™¨è·å–**
![](/images/gmtc/performance/bianyuan1.png)

**å’Œä¼ ç»Ÿçš„ CSR æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

å¼€å§‹è¿˜æ˜¯ CSR,å°†é™æ€èµ„æºæ”¾åœ¨ CDN è¾¹ç¼˜èŠ‚ç‚¹ã€‚éœ€è¦ cdn æœ‰è¾¹ç¼˜è®¡ç®—èƒ½åŠ›ã€‚

**æŠ€æœ¯åŸç†**
![](/images/gmtc/performance/bianyuan2.png)

- ã€1ã€‘ç”¨æˆ·å‘é€è¯·æ±‚
- ã€2ã€‘ã€3ã€‘ã€4ã€‘ CDN ä¸Šçš„ edge worker è¿”å›é¡µé¢æ¥å£å¹¶ä¿æŒè¿æ¥çŠ¶æ€
- ã€7ã€‘ã€8ã€‘ä»æœåŠ¡å™¨è¯»åŸé¡µé¢ï¼Œåœ¨ edge woker ä¸ŠåŒ…è£…ä¸º js ä»£ç ï¼ŒåŠ¨æ€åŠ è½½åˆ° dom ç»“æ„ä¸­

#### åŒå±æ¸²æŸ“è§£å†³äºŒè·³æ€§èƒ½é—®é¢˜

**æŠ€æœ¯åŸç†**
![](/images/gmtc/performance/tongping1.png)
![](/images/gmtc/performance/tongping2.png)

## æ£€æµ‹å·¥å…·

- ğŸ›  [æ¨èï¼šLighthouse - Google](https://developers.google.com/web/tools/lighthouse/#devtools)
- ğŸ›  [æ¨èï¼šWebPagetest - Website Performance and Optimization Test ](https://www.webpagetest.org/)
- ğŸ›  [æ¨èï¼šPageSpeed Insights](https://developers.google.com/speed/pagespeed/insights/)

- ğŸ›  â˜† [Dareboost: Website Speed Test and Website Analysis](https://www.dareboost.com/) (use the coupon WPCDD20 for -20%)
- ğŸ›  [GTmetrix | Website Speed and Performance Optimization](https://gtmetrix.com/)
- ğŸ›  [Web.dev](https://web.dev/measure)
- ğŸ›  [Pingdom Website Speed Test](https://tools.pingdom.com)
- ğŸ“– [Pagespeed - The tool and optimization guide](https://varvy.com/pagespeed/)
- ğŸ“– [Make the Web FasterÂ | Google Developers](https://developers.google.com/speed/)
- ğŸ›  [Sitespeed.io - Welcome to the wonderful world of Web Performance](https://www.sitespeed.io/)
- ğŸ›  [Calibre](https://calibreapp.com/)
- ğŸ›  [Website Speed Test | Check Web Performance &raquo; Dotcom-Tools](https://www.dotcom-tools.com/website-speed-test.aspx)
- ğŸ›  [Website and Server Uptime Monitoring - Pingdom](https://www.pingdom.com/product/uptime-monitoring/) ([Free Signup Link](https://www.pingdom.com/free))
- ğŸ›  [Uptime Robot](https://uptimerobot.com)
- ğŸ›  [SpeedCurve: Monitor front-end performance](https://speedcurve.com)
- ğŸ›  [PWMetrics - CLI tool and lib to gather performance metrics](https://github.com/paulirish/pwmetrics)
- ğŸ›  [Varvy - Page speed optimization](https://varvy.com/pagespeed/)
- ğŸ›  [Checkbot browser extension - Checks for web performance best practices](https://www.checkbot.io/)
- ğŸ›  [Yellow Lab Tools | Online test to help speeding up heavy web pages](https://yellowlab.tools/)
- ğŸ›  [Speedrank - Web Performance Monitoring](https://speedrank.app/)
- ğŸ›  [DebugBear - Monitor website performance and Lighthouse scores](https://www.debugbear.com/)

**å‚è€ƒ**

- [é˜¿é‡Œï¼šå‰ç«¯æ€§èƒ½è¡¡é‡æ ‡å‡†](https://yq.aliyun.com/articles/598162)
